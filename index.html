<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Management App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        input[type="number"], input[type="text"], input[type="email"], input[type="password"] {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s; /* Added transition for polish */
        }
        input[type="number"]:focus, input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s; /* Added box-shadow transition */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); /* Enhanced hover shadow */
        }
        .btn-primary {
            background-color: #6366f1;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4f46e5;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .input-error {
            border-color: #ef4444 !important;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
        }
        .success-message {
            color: #10b981; /* green-500 */
            font-size: 0.875rem; /* text-sm */
            margin-left: 0.5rem; /* ml-2 */
        }
        /* Smooth progress bar transition */
        #cashCushionProgressBar {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container space-y-6">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Asset Management Dashboard</h1>

        <!-- Authentication Section -->
        <div id="authSection" class="card p-6 space-y-4">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Welcome, Patriarch!</h2>
            <p class="text-center text-gray-600 mb-6">Sign up or log in to manage your assets.</p>

            <div>
                <label for="authEmail" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                <input type="email" id="authEmail" placeholder="Enter your email">
                <p id="authEmailError" class="error-message hidden"></p>
            </div>
            <div>
                <label for="authPassword" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                <input type="password" id="authPassword" placeholder="Enter your password">
                <p id="authPasswordError" class="error-message hidden"></p>
            </div>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="signUpBtn" class="btn-primary flex-grow">Sign Up</button>
                <button id="loginBtn" class="btn-secondary flex-grow">Log In</button>
            </div>
            <p id="authStatus" class="error-message text-center hidden"></p>
        </div>

        <!-- Main App Content (Hidden until authenticated) -->
        <div id="mainAppContent" class="hidden space-y-6">
            <!-- User ID Display and Logout -->
            <div class="card p-4 flex items-center justify-between">
                <p class="text-lg font-semibold text-gray-700">Logged in as:</p>
                <span id="userIdDisplay" class="text-lg font-bold text-indigo-700">@Patriarch</span>
                <button id="logoutBtn" class="btn-secondary text-sm">Logout</button>
            </div>

            <!-- Data Type Selector -->
            <div class="card p-6 flex items-center justify-between">
                <h2 class="text-2xl font-semibold text-gray-800">Data Type</h2>
                <div class="flex items-center space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio text-indigo-600" name="dataType" value="real" checked>
                        <span class="ml-2 text-gray-700">Real Data</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio text-indigo-600" name="dataType" value="simulation">
                        <span class="ml-2 text-gray-700">Simulation Data</span>
                    </label>
                </div>
            </div>

            <!-- Income Section -->
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Bi-Weekly Income</h2>
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <input type="number" id="biWeeklyIncomeInput" placeholder="Enter bi-weekly income" class="flex-grow">
                    <button id="saveIncomeBtn" class="btn-primary w-full sm:w-auto">Save Income</button>
                    <span id="incomeStatus" class="success-message hidden"></span>
                </div>
                <p class="mt-4 text-lg text-gray-700">Current Bi-Weekly Income: <span id="currentBiWeeklyIncome" class="font-medium">$0.00</span></p>
                <p id="incomeError" class="error-message hidden"></p>
            </div>

            <!-- Expenses Section -->
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Monthly Expenses</h2>
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <input type="text" id="expenseNameInput" placeholder="Expense Name" class="flex-grow">
                        <input type="number" id="expenseAmountInput" placeholder="Amount" class="flex-grow">
                        <button id="addExpenseBtn" class="btn-primary w-full sm:w-auto">Add Expense</button>
                        <span id="expenseStatus" class="success-message hidden"></span>
                    </div>
                    <p id="expenseNameError" class="error-message hidden"></p>
                    <p id="expenseAmountError" class="error-message hidden"></p>
                    <div id="expensesList" class="space-y-2">
                        <!-- Expenses will be listed here -->
                        <p class="text-gray-500 text-center" id="noExpensesMessage">No expenses added yet.</p>
                    </div>
                </div>
                <p class="mt-6 text-lg text-gray-700">Total Monthly Expenses: <span id="totalMonthlyExpenses" class="font-medium">$0.00</span></p>
                <p class="text-lg text-gray-700">Bi-Weekly Allocation for Monthly Expenses: <span id="biWeeklyExpenseAllocation" class="font-medium">$0.00</span></p>
            </div>

            <!-- Random Expenses Section -->
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Random Expenses (Bi-Weekly)</h2>
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <input type="number" id="randomExpenseInput" placeholder="Enter random expense amount" class="flex-grow">
                    <button id="addRandomExpenseBtn" class="btn-primary w-full sm:w-auto">Add Random Expense</button>
                    <span id="randomExpenseStatus" class="success-message hidden"></span>
                </div>
                <p class="mt-4 text-lg text-gray-700">Current Random Expenses: <span id="currentRandomExpenses" class="font-medium">$0.00</span></p>
                <p id="randomExpenseError" class="error-message hidden"></p>
            </div>

            <!-- Net Income Section -->
            <div class="card p-6 bg-indigo-50">
                <h2 class="text-2xl font-semibold text-indigo-800 mb-4">Financial Summary</h2>
                <p class="text-xl font-bold text-indigo-700">Net Income (Bi-Weekly): <span id="netIncome" class="font-extrabold">$0.00</span></p>
            </div>

            <!-- Portfolio Allocation Section -->
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Portfolio Allocation</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="cryptoAllocation" class="block text-gray-700 text-sm font-bold mb-2">Crypto (%)</label>
                        <input type="number" id="cryptoAllocation" placeholder="e.g., 20" min="0" max="100">
                        <p id="cryptoAllocationError" class="error-message hidden"></p>
                    </div>
                    <div>
                        <label for="stocksAllocation" class="block text-gray-700 text-sm font-bold mb-2">Stocks (%)</label>
                        <input type="number" id="stocksAllocation" placeholder="e.g., 50" min="0" max="100">
                        <p id="stocksAllocationError" class="error-message hidden"></p>
                    </div>
                    <div>
                        <label for="cashMutualFundsAllocation" class="block text-gray-700 text-sm font-bold mb-2">Cash Mutual Funds (%)</label>
                        <input type="number" id="cashMutualFundsAllocation" placeholder="e.g., 30" min="0" max="100">
                        <p id="cashMutualFundsAllocationError" class="error-message hidden"></p>
                    </div>
                </div>
                <button id="saveAllocationBtn" class="btn-primary mt-6 w-full">Save Allocation</button>
                <span id="allocationStatus" class="success-message hidden"></span>
                <p id="totalAllocationError" class="error-message hidden"></p>
                <div class="mt-4 text-gray-700">
                    <p>Current Allocation:</p>
                    <ul id="currentAllocationList" class="list-disc list-inside ml-4">
                        <li>Crypto: <span id="displayCrypto">0%</span></li>
                        <li>Stocks: <span id="displayStocks">0%</span></li>
                        <li>Cash Mutual Funds: <span id="displayCashMutualFunds">0%</span></li>
                    </ul>
                </div>
            </div>

            <!-- Current Asset Values Section -->
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Current Asset Values</h2>
                <p class="text-sm text-gray-600 mb-4">Enter the current market value of your assets to calculate your net worth.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="currentCryptoValueInput" class="block text-gray-700 text-sm font-bold mb-2">Current Crypto Value ($)</label>
                        <input type="number" id="currentCryptoValueInput" placeholder="e.g., 5000" min="0">
                        <p id="currentCryptoValueError" class="error-message hidden"></p>
                    </div>
                    <div>
                        <label for="currentStocksValueInput" class="block text-gray-700 text-sm font-bold mb-2">Current Stocks Value ($)</label>
                        <input type="number" id="currentStocksValueInput" placeholder="e.g., 15000" min="0">
                        <p id="currentStocksValueError" class="error-message hidden"></p>
                    </div>
                    <div>
                        <label for="currentCashMutualFundsValueInput" class="block text-gray-700 text-sm font-bold mb-2">Current Cash & Mutual Funds Value ($)</label>
                        <input type="number" id="currentCashMutualFundsValueInput" placeholder="e.g., 10000" min="0">
                        <p id="currentCashMutualFundsValueError" class="error-message hidden"></p>
                    </div>
                </div>
                <button id="saveAssetValuesBtn" class="btn-primary mt-6 w-full">Save Asset Values</button>
                <span id="assetValuesStatus" class="success-message hidden"></span>
            </div>

            <!-- Current Net Worth Section -->
            <div class="card p-6 bg-purple-50">
                <h2 class="text-2xl font-semibold text-purple-800 mb-4">Current Net Worth</h2>
                <p class="text-xl font-bold text-purple-700">Total Net Worth: <span id="totalNetWorth" class="font-extrabold">$0.00</span></p>
            </div>

            <!-- Projected Portfolio Value Section -->
            <div class="card p-6 bg-blue-50">
                <h2 class="text-2xl font-semibold text-blue-800 mb-4">Projected Portfolio Value</h2>
                <p class="text-sm text-gray-600 mb-4">Enter your expected annual growth rates to see future projections.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="annualCryptoGrowthInput" class="block text-blue-700 text-sm font-bold mb-2">Annual Crypto Growth (%)</label>
                        <input type="number" id="annualCryptoGrowthInput" placeholder="e.g., 10" step="0.1">
                        <p id="annualCryptoGrowthError" class="error-message hidden"></p>
                    </div>
                    <div>
                        <label for="annualStocksGrowthInput" class="block text-blue-700 text-sm font-bold mb-2">Annual Stocks Growth (%)</label>
                        <input type="number" id="annualStocksGrowthInput" placeholder="e.g., 7" step="0.1">
                        <p id="annualStocksGrowthError" class="error-message hidden"></p>
                    </div>
                    <div>
                        <label for="annualCashMutualFundsGrowthInput" class="block text-blue-700 text-sm font-bold mb-2">Annual Cash Mutual Funds Growth (%)</label>
                        <input type="number" id="annualCashMutualFundsGrowthInput" placeholder="e.g., 2" step="0.1">
                        <p id="annualCashMutualFundsGrowthError" class="error-message hidden"></p>
                    </div>
                </div>
                <button id="saveGrowthRatesBtn" class="btn-primary mt-6 w-full">Save Growth Rates & Project</button>
                <span id="growthRatesStatus" class="success-message hidden"></span>

                <div class="mt-6 text-blue-700">
                    <h3 class="text-xl font-semibold mb-2">Projected Totals:</h3>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>Projected 1 Year: <span id="projected1Year" class="font-bold">$0.00</span></li>
                        <li>Projected 3 Years: <span id="projected3Years" class="font-bold">$0.00</span></li>
                        <li>Projected 5 Years: <span id="projected5Years" class="font-bold">$0.00</span></li>
                    </ul>
                    <p class="mt-4 text-sm text-gray-600">Based on your current asset values and specified growth rates.</p>
                </div>
            </div>

            <!-- Cash Cushion Section -->
            <div class="card p-6 bg-green-50">
                <h2 class="text-2xl font-semibold text-green-800 mb-4">Emergency Fund (Cash Cushion)</h2>
                <p class="text-lg text-green-700">Target: <span class="font-bold">$20,000.00</span> in 2 years.</p>
                <p class="text-lg text-green-700">Monthly Target: <span class="font-bold">$833.33</span></p>
                <p class="text-lg text-green-700">Bi-Weekly Target: <span class="font-bold">$416.67</span></p>
                <div class="mt-4">
                    <label for="currentCashCushion" class="block text-green-700 text-sm font-bold mb-2">Current Cash Cushion Amount</label>
                    <input type="number" id="currentCashCushion" placeholder="Enter current amount saved">
                    <p id="cashCushionError" class="error-message hidden"></p>
                    <button id="updateCashCushionBtn" class="btn-primary mt-4 w-full">Update Cash Cushion</button>
                    <span id="cashCushionStatus" class="success-message hidden"></span>
                </div>
                <div class="mt-6">
                    <p class="text-xl font-bold text-green-700">Saved: <span id="displaySavedCashCushion" class="font-extrabold">$0.00</span></p>
                    <p class="text-xl font-bold text-green-700">Remaining: <span id="displayRemainingCashCushion" class="font-extrabold">$20,000.00</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
                        <div id="cashCushionProgressBar" class="bg-green-500 h-4 rounded-full" style="width: 0%;"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-1" id="cashCushionProgressText">0% of target achieved.</p>
                </div>
            </div>
        </div> <!-- End of mainAppContent -->

        <!-- Modal for Rename Expense -->
        <div id="renameModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeRenameModal">&times;</span>
                <h3 class="text-xl font-semibold mb-4">Rename Expense</h3>
                <input type="text" id="newExpenseNameInput" placeholder="New Expense Name" class="mb-4">
                <p id="renameExpenseError" class="error-message hidden"></p>
                <button id="confirmRenameBtn" class="btn-primary w-full">Rename</button>
                <span id="renameStatus" class="success-message hidden"></span>
            </div>
        </div>

        <!-- Modal for Confirmation -->
        <div id="confirmationModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-semibold mb-4" id="confirmationModalTitle">Confirm Action</h3>
                <p class="mb-6" id="confirmationModalMessage">Are you sure you want to proceed?</p>
                <div class="flex justify-end space-x-4">
                    <button id="cancelConfirmBtn" class="btn-secondary">Cancel</button>
                    <button id="confirmActionBtn" class="btn-primary">Confirm</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and user data
        let app;
        let db;
        let auth;
        let userId; // This will hold the Firebase UID
        let unsubscribeIncome;
        let unsubscribeExpenses;
        let unsubscribeRandomExpenses;
        let unsubscribeAllocation;
        let unsubscribeCashCushion;
        let unsubscribeAssetValues;
        let unsubscribeGrowthRates;

        // Firebase configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyCbmW_3fHbPHV-9raz8afJidmbgDFOqmVM",
            authDomain: "mypatriarch-b11c1.firebaseapp.com",
            projectId: "mypatriarch-b11c1",
            storageBucket: "mypatriarch-b11c1.firebasestorage.app",
            messagingSenderId: "605769942473",
            appId: "1:605769942473:web:3f04cc4392ac8e665b5418",
            measurementId: "G-Y2G56553TY"
        };

        // Use __app_id if available, otherwise fall back to projectId from firebaseConfig
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // UI Elements
        const authSection = document.getElementById('authSection');
        const mainAppContent = document.getElementById('mainAppContent');
        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');
        const signUpBtn = document.getElementById('signUpBtn');
        const loginBtn = document.getElementById('loginBtn');
        const authStatus = document.getElementById('authStatus');
        const authEmailError = document.getElementById('authEmailError');
        const authPasswordError = document.getElementById('authPasswordError');
        const logoutBtn = document.getElementById('logoutBtn');

        const biWeeklyIncomeInput = document.getElementById('biWeeklyIncomeInput');
        const saveIncomeBtn = document.getElementById('saveIncomeBtn');
        const currentBiWeeklyIncomeSpan = document.getElementById('currentBiWeeklyIncome');
        const incomeStatus = document.getElementById('incomeStatus');
        const incomeError = document.getElementById('incomeError');

        const expenseNameInput = document.getElementById('expenseNameInput');
        const expenseAmountInput = document.getElementById('expenseAmountInput');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const expensesList = document.getElementById('expensesList');
        const noExpensesMessage = document.getElementById('noExpensesMessage');
        const totalMonthlyExpensesSpan = document.getElementById('totalMonthlyExpenses');
        const biWeeklyExpenseAllocationSpan = document.getElementById('biWeeklyExpenseAllocation');
        const expenseStatus = document.getElementById('expenseStatus');
        const expenseNameError = document.getElementById('expenseNameError');
        const expenseAmountError = document.getElementById('expenseAmountError');

        const randomExpenseInput = document.getElementById('randomExpenseInput');
        const addRandomExpenseBtn = document.getElementById('addRandomExpenseBtn');
        const currentRandomExpensesSpan = document.getElementById('currentRandomExpenses');
        const randomExpenseStatus = document.getElementById('randomExpenseStatus');
        const randomExpenseError = document.getElementById('randomExpenseError');

        const netIncomeSpan = document.getElementById('netIncome');

        const cryptoAllocationInput = document.getElementById('cryptoAllocation');
        // FIX: Corrected typo here. Was 'document = document.getElementById'
        const stocksAllocationInput = document.getElementById('stocksAllocation');
        const cashMutualFundsAllocationInput = document.getElementById('cashMutualFundsAllocation');
        const saveAllocationBtn = document.getElementById('saveAllocationBtn');
        const displayCryptoSpan = document.getElementById('displayCrypto');
        const displayStocksSpan = document.getElementById('displayStocks');
        const displayCashMutualFundsSpan = document.getElementById('displayCashMutualFunds');
        const allocationStatus = document.getElementById('allocationStatus');
        const cryptoAllocationError = document.getElementById('cryptoAllocationError');
        const stocksAllocationError = document.getElementById('stocksAllocationError');
        const cashMutualFundsAllocationError = document.getElementById('cashMutualFundsAllocationError');
        const totalAllocationError = document.getElementById('totalAllocationError');


        const currentCryptoValueInput = document.getElementById('currentCryptoValueInput');
        const currentStocksValueInput = document.getElementById('currentStocksValueInput');
        const currentCashMutualFundsValueInput = document.getElementById('currentCashMutualFundsValueInput');
        const saveAssetValuesBtn = document.getElementById('saveAssetValuesBtn');
        const assetValuesStatus = document.getElementById('assetValuesStatus');
        const currentCryptoValueError = document.getElementById('currentCryptoValueError');
        const currentStocksValueError = document.getElementById('currentStocksValueError');
        const currentCashMutualFundsValueError = document.getElementById('currentCashMutualFundsValueError');

        const totalNetWorthSpan = document.getElementById('totalNetWorth');

        const annualCryptoGrowthInput = document.getElementById('annualCryptoGrowthInput');
        const annualStocksGrowthInput = document.getElementById('annualStocksGrowthInput');
        const annualCashMutualFundsGrowthInput = document.getElementById('annualCashMutualFundsGrowthInput');
        const saveGrowthRatesBtn = document.getElementById('saveGrowthRatesBtn');
        const projected1YearSpan = document.getElementById('projected1Year');
        const projected3YearsSpan = document.getElementById('projected3Years');
        const projected5YearsSpan = document.getElementById('projected5Years');
        const growthRatesStatus = document.getElementById('growthRatesStatus');
        const annualCryptoGrowthError = document.getElementById('annualCryptoGrowthError');
        const annualStocksGrowthError = document.getElementById('annualStocksGrowthError');
        const annualCashMutualFundsGrowthError = document.getElementById('annualCashMutualFundsGrowthError');

        const currentCashCushionInput = document.getElementById('currentCashCushion');
        const updateCashCushionBtn = document.getElementById('updateCashCushionBtn');
        const displaySavedCashCushionSpan = document.getElementById('displaySavedCashCushion');
        const displayRemainingCashCushionSpan = document.getElementById('displayRemainingCashCushion');
        const cashCushionProgressBar = document.getElementById('cashCushionProgressBar');
        const cashCushionProgressText = document.getElementById('cashCushionProgressText');
        const cashCushionStatus = document.getElementById('cashCushionStatus');
        const cashCushionError = document.getElementById('cashCushionError');

        const userIdDisplay = document.getElementById('userIdDisplay');
        const dataTypeRadios = document.querySelectorAll('input[name="dataType"]');

        // Modals
        const renameModal = document.getElementById('renameModal');
        const closeRenameModalBtn = document.getElementById('closeRenameModal');
        const newExpenseNameInput = document.getElementById('newExpenseNameInput');
        const confirmRenameBtn = document.getElementById('confirmRenameBtn');
        const renameStatus = document.getElementById('renameStatus');
        const renameExpenseError = document.getElementById('renameExpenseError');
        let currentExpenseToRenameId = null;

        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        let confirmationCallback = null;

        // Data variables
        let biWeeklyIncome = 0;
        let monthlyExpenses = []; // Array of { id, name, amount }
        let randomExpenses = 0;
        let portfolioAllocation = { crypto: 0, stocks: 0, cashMutualFunds: 0 };
        const CASH_CUSHION_TARGET = 20000;
        const CASH_CUSHION_MONTHLY_TARGET = CASH_CUSHION_TARGET / 24; // 2 years = 24 months
        const CASH_CUSHION_BIWEEKLY_TARGET = CASH_CUSHION_MONTHLY_TARGET / 2;
        let currentCashCushion = 0;
        let currentDataType = 'real'; // Default data type

        let currentCryptoValue = 0;
        let currentStocksValue = 0;
        let currentCashMutualFundsValue = 0;

        let annualCryptoGrowthRate = 0;
        let annualStocksGrowthRate = 0;
        let annualCashMutualFundsGrowthRate = 0;

        /**
         * Shows a loading spinner next to the given button.
         * @param {HTMLElement} button - The button element to show the spinner next to.
         */
        function showButtonLoading(button) {
            button.disabled = true;
            let spinner = button.querySelector('.loader');
            if (!spinner) {
                spinner = document.createElement('div');
                spinner.className = 'loader ml-2 inline-block align-middle';
                button.appendChild(spinner);
            }
            spinner.style.display = 'inline-block';
        }

        /**
         * Hides the loading spinner next to the given button.
         * @param {HTMLElement} button - The button element to hide the spinner from.
         */
        function hideButtonLoading(button) {
            button.disabled = false;
            const spinner = button.querySelector('.loader');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }

        /**
         * Displays a temporary success or error message.
         * @param {HTMLElement} statusElement - The span element to display the message.
         * @param {string} message - The message to display.
         * @param {boolean} isSuccess - True for success, false for error.
         */
        function showStatusMessage(statusElement, message, isSuccess = true) {
            statusElement.textContent = message;
            statusElement.classList.remove('hidden', 'success-message', 'error-message'); // Clear both
            statusElement.classList.add(isSuccess ? 'success-message' : 'error-message');
            // Make error messages stay longer
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, isSuccess ? 3000 : 5000); // Shorter for success, longer for error
        }

        /**
         * Displays an error message and highlights the input.
         * @param {HTMLElement} inputElement - The input element to highlight.
         * @param {HTMLElement} errorElement - The span element to display the error message.
         */
        function showInputError(inputElement, errorElement, message) {
            inputElement.classList.add('input-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        /**
         * Clears an error message and removes input highlight.
         * @param {HTMLElement} inputElement - The input element.
         * @param {HTMLElement} errorElement - The error message span.
         */
        function clearInputError(inputElement, errorElement) {
            inputElement.classList.remove('input-error');
            errorElement.classList.add('hidden');
            errorElement.textContent = '';
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display.
         * @param {function} onConfirm - Callback function to execute if confirmed.
         */
        function showConfirmationModal(title, message, onConfirm) {
            confirmationModalTitle.textContent = title;
            confirmationModalMessage.textContent = message;
            confirmationCallback = onConfirm;
            confirmationModal.style.display = 'flex';
        }

        /**
         * Hides the confirmation modal.
         */
        function hideConfirmationModal() {
            confirmationModal.style.display = 'none';
            confirmationCallback = null;
        }

        /**
         * Shows the rename expense modal.
         * @param {string} expenseId - The ID of the expense to rename.
         * @param {string} currentName - The current name of the expense.
         */
        function showRenameModal(expenseId, currentName) {
            currentExpenseToRenameId = expenseId;
            newExpenseNameInput.value = currentName;
            clearInputError(newExpenseNameInput, renameExpenseError); // Clear previous errors
            renameModal.style.display = 'flex';
        }

        /**
         * Hides the rename expense modal.
         */
        function hideRenameModal() {
            renameModal.style.display = 'none';
            currentExpenseToRenameId = null;
            newExpenseNameInput.value = '';
            renameStatus.classList.add('hidden'); // Hide status message
        }

        /**
         * Handles the confirmation of renaming an expense.
         */
        async function handleRenameConfirm() {
            const newName = newExpenseNameInput.value.trim();
            if (!newName) {
                showInputError(newExpenseNameInput, renameExpenseError, 'Expense name cannot be empty.');
                return;
            }
            clearInputError(newExpenseNameInput, renameExpenseError);

            if (currentExpenseToRenameId && newName) {
                showButtonLoading(confirmRenameBtn);
                try {
                    await renameExpense(currentExpenseToRenameId, newName);
                    showStatusMessage(renameStatus, 'Renamed!');
                    setTimeout(hideRenameModal, 1000); // Hide after a short delay to show message
                } catch (error) {
                    console.error("Error renaming expense:", error);
                    showStatusMessage(renameStatus, 'Rename failed!', false);
                } finally {
                    hideButtonLoading(confirmRenameBtn);
                }
            }
        }

        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log('Firebase services initialized:', { app, db, auth });

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Set display name to @Patriarch if not already set
                        if (user.displayName !== "@Patriarch") {
                            await updateProfile(user, { displayName: "@Patriarch" });
                        }
                        userIdDisplay.textContent = user.displayName || "@Patriarch"; // Display @Patriarch
                        console.log('User signed in with UID:', userId);
                        authSection.classList.add('hidden');
                        mainAppContent.classList.remove('hidden');
                        loadAllData();
                    } else {
                        console.log('No user signed in.');
                        userId = null; // Clear userId when logged out
                        userIdDisplay.textContent = 'Not signed in'; // Fallback if not logged in
                        authSection.classList.remove('hidden');
                        mainAppContent.classList.add('hidden');
                        clearAllData(); // Clear data when logged out
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                userIdDisplay.textContent = 'Error loading user';
                showStatusMessage(authStatus, `Firebase Init Error: ${error.message}`, false);
            }
        }

        /**
         * Handles user sign-up with email and password.
         */
        async function handleSignUp() {
            clearInputError(authEmailInput, authEmailError);
            clearInputError(authPasswordInput, authPasswordError);
            authStatus.classList.add('hidden'); // Hide general auth status

            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();

            if (!email) { showInputError(authEmailInput, authEmailError, "Email is required."); return; }
            if (password.length < 6) { showInputError(authPasswordInput, authPasswordError, "Password must be at least 6 characters."); return; }

            showButtonLoading(signUpBtn);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: "@Patriarch" });
                authEmailInput.value = '';
                authPasswordInput.value = '';
                showStatusMessage(authStatus, 'Sign up successful! Logging in...', true);
                // onAuthStateChanged will handle showing main content
            } catch (error) {
                let errorMessage = "Sign up failed.";
                switch (error.code) {
                    case 'auth/email-already-in-use': errorMessage = "Email already in use. Try logging in."; break;
                    case 'auth/invalid-email': errorMessage = "Invalid email address."; break;
                    case 'auth/weak-password': errorMessage = "Password is too weak."; break;
                    default: errorMessage = `Error: ${error.message}`; break;
                }
                showStatusMessage(authStatus, errorMessage, false);
                console.error("Sign up error:", error);
            } finally {
                hideButtonLoading(signUpBtn);
            }
        }

        /**
         * Handles user login with email and password.
         */
        async function handleLogin() {
            clearInputError(authEmailInput, authEmailError);
            clearInputError(authPasswordInput, authPasswordError);
            authStatus.classList.add('hidden'); // Hide general auth status

            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();

            if (!email) { showInputError(authEmailInput, authEmailError, "Email is required."); return; }
            if (!password) { showInputError(authPasswordInput, authPasswordError, "Password is required."); return; }

            showButtonLoading(loginBtn);
            try {
                await signInWithEmailAndPassword(auth, email, password);
                authEmailInput.value = '';
                authPasswordInput.value = '';
                showStatusMessage(authStatus, 'Login successful!', true);
                // onAuthStateChanged will handle showing main content
            } catch (error) {
                let errorMessage = "Login failed.";
                switch (error.code) {
                    case 'auth/invalid-email': errorMessage = "Invalid email address."; break;
                    case 'auth/user-disabled': errorMessage = "User account disabled."; break;
                    case 'auth/user-not-found': errorMessage = "No user found with this email."; break;
                    case 'auth/wrong-password': errorMessage = "Incorrect password."; break;
                    default: errorMessage = `Error: ${error.message}`; break;
                }
                showStatusMessage(authStatus, errorMessage, false);
                console.error("Login error:", error);
            } finally {
                hideButtonLoading(loginBtn);
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                console.log("User logged out.");
                // onAuthStateChanged will handle showing auth section and clearing data
            } catch (error) {
                console.error("Error logging out:", error);
                showStatusMessage(userIdDisplay, 'Logout failed!', false); // Display error near user ID
            }
        }

        /**
         * Clears all displayed data in the UI.
         */
        function clearAllData() {
            biWeeklyIncome = 0;
            monthlyExpenses = [];
            randomExpenses = 0;
            portfolioAllocation = { crypto: 0, stocks: 0, cashMutualFunds: 0 };
            currentCashCushion = 0;
            currentCryptoValue = 0;
            currentStocksValue = 0;
            currentCashMutualFundsValue = 0;
            annualCryptoGrowthRate = 0;
            annualStocksGrowthRate = 0;
            annualCashMutualFundsGrowthRate = 0;

            updateIncomeDisplay();
            updateExpensesDisplay();
            updateRandomExpensesDisplay();
            updatePortfolioAllocationDisplay();
            updateCashCushionDisplay();
            updateAssetValuesDisplay();
            updateGrowthRatesDisplay();
            calculateAndDisplayNetIncome();
            calculateAndDisplayNetWorth();
            projectPortfolioValues();

            // Unsubscribe from all previous listeners
            if (unsubscribeIncome) unsubscribeIncome();
            if (unsubscribeExpenses) unsubscribeExpenses();
            if (unsubscribeRandomExpenses) unsubscribeRandomExpenses();
            if (unsubscribeAllocation) unsubscribeAllocation();
            if (unsubscribeCashCushion) unsubscribeCashCushion();
            if (unsubscribeAssetValues) unsubscribeAssetValues();
            if (unsubscribeGrowthRates) unsubscribeGrowthRates();
        }

        /**
         * Loads all financial data from Firestore for the current user and data type.
         */
        function loadAllData() {
            // Ensure userId is available before attempting to load data
            if (!userId) {
                console.warn("Cannot load data: User not authenticated.");
                return;
            }

            // Clear existing data and unsubscribe from old listeners before setting up new ones
            clearAllData();

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/${currentDataType}/data`);

            unsubscribeIncome = onSnapshot(doc(userDocRef, 'income', 'biWeekly'), (docSnap) => {
                biWeeklyIncome = docSnap.exists() ? docSnap.data().amount || 0 : 0;
                updateIncomeDisplay();
                calculateAndDisplayNetIncome();
            }, (error) => console.error("Error fetching income:", error));

            unsubscribeExpenses = onSnapshot(collection(userDocRef, 'expenses'), (snapshot) => {
                monthlyExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateExpensesDisplay();
                calculateAndDisplayNetIncome();
            }, (error) => console.error("Error fetching expenses:", error));

            unsubscribeRandomExpenses = onSnapshot(doc(userDocRef, 'randomExpenses', 'current'), (docSnap) => {
                randomExpenses = docSnap.exists() ? docSnap.data().amount || 0 : 0;
                updateRandomExpensesDisplay();
                calculateAndDisplayNetIncome();
            }, (error) => console.error("Error fetching random expenses:", error));

            unsubscribeAllocation = onSnapshot(doc(userDocRef, 'portfolioAllocation', 'current'), (docSnap) => {
                portfolioAllocation = docSnap.exists() ? docSnap.data() : { crypto: 0, stocks: 0, cashMutualFunds: 0 };
                updatePortfolioAllocationDisplay();
            }, (error) => console.error("Error fetching portfolio allocation:", error));

            unsubscribeCashCushion = onSnapshot(doc(userDocRef, 'cashCushion', 'current'), (docSnap) => {
                currentCashCushion = docSnap.exists() ? docSnap.data().amount || 0 : 0;
                updateCashCushionDisplay();
                calculateAndDisplayNetWorth();
            }, (error) => console.error("Error fetching cash cushion:", error));

            unsubscribeAssetValues = onSnapshot(doc(userDocRef, 'assetValues', 'current'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentCryptoValue = data.crypto || 0;
                    currentStocksValue = data.stocks || 0;
                    currentCashMutualFundsValue = data.cashMutualFunds || 0;
                } else {
                    currentCryptoValue = 0;
                    currentStocksValue = 0;
                    currentCashMutualFundsValue = 0;
                }
                updateAssetValuesDisplay();
                calculateAndDisplayNetWorth();
                projectPortfolioValues();
            }, (error) => console.error("Error fetching asset values:", error));

            unsubscribeGrowthRates = onSnapshot(doc(userDocRef, 'growthRates', 'annual'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    annualCryptoGrowthRate = data.crypto || 0;
                    annualStocksGrowthRate = data.stocks || 0;
                    annualCashMutualFundsGrowthRate = data.cashMutualFunds || 0;
                } else {
                    annualCryptoGrowthRate = 0;
                    annualStocksGrowthRate = 0;
                    annualCashMutualFundsGrowthRate = 0;
                }
                updateGrowthRatesDisplay();
                projectPortfolioValues();
            }, (error) => console.error("Error fetching growth rates:", error));
        }

        /**
         * Saves the bi-weekly income to Firestore.
         */
        async function saveBiWeeklyIncome() {
            // Log state before operation
            console.log("--- Attempting to save income ---");
            console.log("db:", db);
            console.log("appId:", appId);
            console.log("userId:", userId);
            console.log("currentDataType:", currentDataType);

            if (!userId || !db) {
                showStatusMessage(incomeStatus, 'App not ready. Please log in and wait.', false);
                return;
            }
            clearInputError(biWeeklyIncomeInput, incomeError);
            const amount = parseFloat(biWeeklyIncomeInput.value);
            if (isNaN(amount) || amount < 0) {
                showInputError(biWeeklyIncomeInput, incomeError, "Please enter a valid positive number.");
                return;
            }
            showButtonLoading(saveIncomeBtn);
            try {
                const incomeDocRef = doc(db, `artifacts/${appId}/users/${userId}/${currentDataType}/data/income`, 'biWeekly');
                await setDoc(incomeDocRef, { amount: amount }, { merge: true });
                biWeeklyIncomeInput.value = '';
                showStatusMessage(incomeStatus, 'Saved!');
            } catch (error) {
                console.error("Error saving bi-weekly income:", error.message || error); // Log specific error message
                showStatusMessage(incomeStatus, 'Save failed!', false);
            } finally {
                hideButtonLoading(saveIncomeBtn);
            }
        }

        /**
         * Updates the displayed bi-weekly income.
         */
        function updateIncomeDisplay() {
            currentBiWeeklyIncomeSpan.textContent = `$${biWeeklyIncome.toFixed(2)}`;
        }

        /**
         * Adds a new monthly expense to Firestore.
         */
        async function addExpense() {
            // Log state before operation
            console.log("--- Attempting to add expense ---");
            console.log("db:", db);
            console.log("appId:", appId);
            console.log("userId:", userId);
            console.log("currentDataType:", currentDataType);

            if (!userId || !db) {
                showStatusMessage(expenseStatus, 'App not ready. Please log in and wait.', false);
                return;
            }
            clearInputError(expenseNameInput, expenseNameError);
            clearInputError(expenseAmountInput, expenseAmountError);

            const name = expenseNameInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);

            let isValid = true;
            if (!name) {
                showInputError(expenseNameInput, expenseNameError, "Expense name cannot be empty.");
                isValid = false;
            }
            if (isNaN(amount) || amount <= 0) {
                showInputError(expenseAmountInput, expenseAmountError, "Please enter a positive amount.");
                isValid = false;
            }
            if (!isValid) return;

            showButtonLoading(addExpenseBtn);
            try {
                const expensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/${currentDataType}/data/expenses`);
                await addDoc(expensesCollectionRef, { name, amount });
                expenseNameInput.value = '';
                expenseAmountInput.value = '';
                showStatusMessage(expenseStatus, 'Added!');
            } catch (error) {
                console.error("Error adding expense:", error.message || error); // Log specific error message
                showStatusMessage(expenseStatus, 'Add failed!', false);
            } finally {
                hideButtonLoading(addExpenseBtn);
            }
        }

        /**
         * Updates the displayed list of monthly expenses and calculates totals.
         */
        function updateExpensesDisplay() {
            expensesList.innerHTML = '';
            let totalMonthly = 0;

            if (monthlyExpenses.length === 0) {
                noExpensesMessage.style.display = 'block';
            } else {
                noExpensesMessage.style.display = 'none';
                monthlyExpenses.forEach(expense => {
                    totalMonthly += expense.amount;
                    const expenseItem = document.createElement('div');
                    expenseItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-md shadow-sm';
                    expenseItem.innerHTML = `
                        <span class="text-gray-800 font-medium">${expense.name}: $${expense.amount.toFixed(2)}</span>
                        <div class="space-x-2">
                            <button data-id="${expense.id}" class="btn-secondary text-sm px-3 py-1 rename-expense-btn">Rename</button>
                            <button data-id="${expense.id}" class="btn-danger text-sm px-3 py-1 remove-expense-btn">Remove</button>
                        </div>
                    `;
                    expensesList.appendChild(expenseItem);
                });
            }

            totalMonthlyExpensesSpan.textContent = `$${totalMonthly.toFixed(2)}`;
            biWeeklyExpenseAllocationSpan.textContent = `$${(totalMonthly / 2).toFixed(2)}`;
        }

        /**
         * Removes a monthly expense from Firestore.
         * @param {string} expenseId - The ID of the expense to remove.
         */
        async function removeExpense(expenseId) {
            showConfirmationModal(
                "Confirm Deletion",
                "Are you sure you want to remove this expense?",
                async () => {
                    // Log state before operation
                    console.log("--- Attempting to remove expense ---");
                    console.log("db:", db);
                    console.log("appId:", appId);
                    console.log("userId:", userId);
                    console.log("currentDataType:", currentDataType);

                    if (!userId || !db) {
                        showStatusMessage(expenseStatus, 'App not ready. Please log in and wait.', false);
                        hideConfirmationModal(); // Hide modal if not ready
                        return;
                    }
                    try {
                        const expenseDocRef = doc(db, `artifacts/${appId}/users/${userId}/${currentDataType}/data/expenses`, expenseId);
                        await deleteDoc(expenseDocRef);
                        console.log("Expense removed successfully.");
                    } catch (error) {
                        console.error("Error removing expense:", error.message || error);
                        showStatusMessage(expenseStatus, 'Removal failed!', false);
                    } finally {
                        hideConfirmationModal();
                    }
                }
            );
        }

        /**
         * Renames a monthly expense in Firestore.
         * @param {string} expenseId - The ID of the expense to rename.
         * @param {string} newName - The new name for the expense.
         */
        async function renameExpense(expenseId, newName) {
            // Log state before operation
            console.log("--- Attempting to rename expense ---");
            console.log("db:", db);
            console.log("appId:", appId);
            console.log("userId:", userId);
            console.log("currentDataType:", currentDataType);

            if (!userId || !db) {
                showStatusMessage(renameStatus, 'App not ready. Please log in and wait.', false);
                throw new Error('User not authenticated or DB not initialized for rename.'); // Re-throw to be caught by handleRenameConfirm
            }
            try {
                const expenseDocRef = doc(db, `artifacts/${appId}/users/${userId}/${currentDataType}/data/expenses`, expenseId);
                await updateDoc(expenseDocRef, { name: newName });
                console.log("Expense renamed successfully.");
            } catch (error) {
                console.error("Error renaming expense:", error.message || error);
                throw error;
            }
        }

        /**
         * Adds a random expense amount to Firestore.
         */
        async function addRandomExpense() {
            // Log state before operation
            console.log("--- Attempting to add random expense ---");
            console.log("db:", db);
            console.log("appId:", appId);
            console.log("userId:", userId);
            console.log("currentDataType:", currentDataType);

            if (!userId || !db) {
                showStatusMessage(randomExpenseStatus, 'App not ready. Please log in and wait.', false);
                return;
            }
            clearInputError(randomExpenseInput, randomExpenseError);
            const amount = parseFloat(randomExpenseInput.value);
            if (isNaN(amount) || amount < 0) {
                showInputError(randomExpenseInput, randomExpenseError, "Please enter a valid positive number.");
                return;
            }
            showButtonLoading(addRandomExpenseBtn);
            try {
                const randomExpenseDocRef = doc(db, `artifacts/${appId}/users/${userId}/${currentDataType}/data/randomExpenses`, 'current');
                const docSnap = await getDoc(randomExpenseDocRef);
                const currentAmount = docSnap.exists() ? docSnap.data().amount : 0;
                await setDoc(randomExpenseDocRef, { amount: currentAmount + amount }, { merge: true });
                randomExpenseInput.value = '';
                showStatusMessage(randomExpenseStatus, 'Added!');
            } catch (error) {
                console.error("Error adding random expense:", error.message || error);
                showStatusMessage(randomExpenseStatus, 'Add failed!', false);
            } finally {
                hideButtonLoading(addRandomExpenseBtn);
            }
        }

        /**
         * Updates the displayed random expenses.
         */
        function updateRandomExpensesDisplay() {
            currentRandomExpensesSpan.textContent = `$${randomExpenses.toFixed(2)}`;
        }

        /**
         * Calculates and displays the net income.
         */
        function calculateAndDisplayNetIncome() {
            const totalMonthlyExpenses = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const biWeeklyExpenseAllocation = totalMonthlyExpenses / 2;
            const netIncome = biWeeklyIncome - biWeeklyExpenseAllocation - randomExpenses;
            netIncomeSpan.textContent = `$${netIncome.toFixed(2)}`;
        }

        /**
         * Saves the portfolio allocation percentages to Firestore.
         */
        async function savePortfolioAllocation() {
            // Log state before operation
            console.log("--- Attempting to save portfolio allocation ---");
            console.log("db:", db);
            console.log("appId:", appId);
            console.log("userId:", userId);
            console.log("currentDataType:", currentDataType);

            if (!userId || !db) {
                showStatusMessage(allocationStatus, 'App not ready. Please log in and wait.', false);
                return;
            }
            clearInputError(cryptoAllocationInput, cryptoAllocationError);
            clearInputError(stocksAllocationInput, stocksAllocationError);
            clearInputError(cashMutualFundsAllocationInput, cashMutualFundsAllocationError);
            clearInputError(saveAllocationBtn, totalAllocationError);

            const crypto = parseFloat(cryptoAllocationInput.value || 0);
            const stocks = parseFloat(stocksAllocationInput.value || 0);
            const cashMutualFunds = parseFloat(cashMutualFundsAllocationInput.value || 0);

            let isValid = true;
            if (isNaN(crypto) || crypto < 0 || crypto > 100) { showInputError(cryptoAllocationInput, cryptoAllocationError, "0-100%"); isValid = false; }
            if (isNaN(stocks) || stocks < 0 || stocks > 100) { showInputError(stocksAllocationInput, stocksAllocationError, "0-100%"); isValid = false; }
            if (isNaN(cashMutualFunds) || cashMutualFunds < 0 || cashMutualFunds > 100) { showInputError(cashMutualFundsAllocationInput, cashMutualFundsAllocationError, "0-100%"); isValid = false; }

            const totalPercentage = crypto + stocks + cashMutualFunds;
            if (totalPercentage !== 100) {
                showInputError(saveAllocationBtn, totalAllocationError, "Total allocation must be 100%. Current: " + totalPercentage + "%");
                isValid = false;
            }
            if (!isValid) return;

            showButtonLoading(saveAllocationBtn);
            try {
                const allocationDocRef = doc(db, `artifacts/${appId}/users/${userId}/${currentDataType}/data/portfolioAllocation`, 'current');
                await setDoc(allocationDocRef, { crypto, stocks, cashMutualFunds }, { merge: true });
                showStatusMessage(allocationStatus, 'Saved!');
            } catch (error) {
                console.error("Error saving portfolio allocation:", error.message || error);
                showStatusMessage(allocationStatus, 'Save failed!', false);
            } finally {
                hideButtonLoading(saveAllocationBtn);
            }
        }

        /**
         * Updates the displayed portfolio allocation percentages.
         */
        function updatePortfolioAllocationDisplay() {
            displayCryptoSpan.textContent = `${portfolioAllocation.crypto || 0}%`;
            displayStocksSpan.textContent = `${portfolioAllocation.stocks || 0}%`;
            displayCashMutualFundsSpan.textContent = `${portfolioAllocation.cashMutualFunds || 0}%`;

            cryptoAllocationInput.value = portfolioAllocation.crypto || '';
            stocksAllocationInput.value = portfolioAllocation.stocks || '';
            cashMutualFundsAllocationInput.value = portfolioAllocation.cashMutualFunds || '';
        }

        /**
         * Saves the current asset values to Firestore.
         */
        async function saveAssetValues() {
            // Log state before operation
            console.log("--- Attempting to save asset values ---");
            console.log("db:", db);
            console.log("appId:", appId);
            console.log("userId:", userId);
            console.log("currentDataType:", currentDataType);

            if (!userId || !db) {
                showStatusMessage(assetValuesStatus, 'App not ready. Please log in and wait.', false);
                return;
            }
            clearInputError(currentCryptoValueInput, currentCryptoValueError);
            clearInputError(currentStocksValueInput, currentStocksValueError);
            clearInputError(currentCashMutualFundsValueInput, currentCashMutualFundsValueError);

            const crypto = parseFloat(currentCryptoValueInput.value || 0);
            const stocks = parseFloat(currentStocksValueInput.value || 0);
            const cashMutualFunds = parseFloat(currentCashMutualFundsValueInput.value || 0);

            let isValid = true;
            if (isNaN(crypto) || crypto < 0) { showInputError(currentCryptoValueInput, currentCryptoValueError, "Positive number required."); isValid = false; }
            if (isNaN(stocks) || stocks < 0) { showInputError(currentStocksValueInput, currentStocksValueError, "Positive number required."); isValid = false; }
            if (isNaN(cashMutualFunds) || cashMutualFunds < 0) { showInputError(currentCashMutualFundsValueInput, currentCashMutualFundsValueError, "Positive number required."); isValid = false; }
            if (!isValid) return;

            showButtonLoading(saveAssetValuesBtn);
            try {
                const assetValuesDocRef = doc(db, `artifacts/${appId}/users/${userId}/${currentDataType}/data/assetValues`, 'current');
                await setDoc(assetValuesDocRef, {
                    crypto: crypto,
                    stocks: stocks,
                    cashMutualFunds: cashMutualFunds
                }, { merge: true });
                showStatusMessage(assetValuesStatus, 'Saved!');
            } catch (error) {
                console.error("Error saving asset values:", error.message || error);
                showStatusMessage(assetValuesStatus, 'Save failed!', false);
            } finally {
                hideButtonLoading(saveAssetValuesBtn);
            }
        }

        /**
         * Updates the displayed current asset values.
         */
        function updateAssetValuesDisplay() {
            currentCryptoValueInput.value = currentCryptoValue;
            currentStocksValueInput.value = currentStocksValue;
            currentCashMutualFundsValueInput.value = currentCashMutualFundsValue;
        }

        /**
         * Calculates and displays the total net worth.
         */
        function calculateAndDisplayNetWorth() {
            const totalNetWorth = currentCashCushion + currentCryptoValue + currentStocksValue + currentCashMutualFundsValue;
            totalNetWorthSpan.textContent = `$${totalNetWorth.toFixed(2)}`;
        }

        /**
         * Saves the annual growth rates to Firestore.
         */
        async function saveGrowthRates() {
            // Log state before operation
            console.log("--- Attempting to save growth rates ---");
            console.log("db:", db);
            console.log("appId:", appId);
            console.log("userId:", userId);
            console.log("currentDataType:", currentDataType);

            if (!userId || !db) {
                showStatusMessage(growthRatesStatus, 'App not ready. Please log in and wait.', false);
                return;
            }
            clearInputError(annualCryptoGrowthInput, annualCryptoGrowthError);
            clearInputError(annualStocksGrowthInput, annualStocksGrowthError);
            clearInputError(annualCashMutualFundsGrowthInput, annualCashMutualFundsGrowthError);

            const crypto = parseFloat(annualCryptoGrowthInput.value || 0);
            const stocks = parseFloat(annualStocksGrowthInput.value || 0);
            const cashMutualFunds = parseFloat(annualCashMutualFundsGrowthInput.value || 0);

            let isValid = true;
            if (isNaN(crypto)) { showInputError(annualCryptoGrowthInput, annualCryptoGrowthError, "Number required."); isValid = false; }
            if (isNaN(stocks)) { showInputError(annualStocksGrowthInput, annualStocksGrowthError, "Number required."); isValid = false; }
            if (isNaN(cashMutualFunds)) { showInputError(annualCashMutualFundsGrowthInput, annualCashMutualFundsGrowthError, "Number required."); isValid = false; }
            if (!isValid) return;

            showButtonLoading(saveGrowthRatesBtn);
            try {
                const growthRatesDocRef = doc(db, `artifacts/${appId}/users/${userId}/${currentDataType}/data/growthRates`, 'annual');
                await setDoc(growthRatesDocRef, {
                    crypto: crypto,
                    stocks: stocks,
                    cashMutualFunds: cashMutualFunds
                }, { merge: true });
                showStatusMessage(growthRatesStatus, 'Saved!');
            } catch (error) {
                console.error("Error saving growth rates:", error.message || error);
                showStatusMessage(growthRatesStatus, 'Save failed!', false);
            } finally {
                hideButtonLoading(saveGrowthRatesBtn);
            }
        }

        /**
         * Updates the displayed annual growth rates.
         */
        function updateGrowthRatesDisplay() {
            annualCryptoGrowthInput.value = annualCryptoGrowthRate;
            annualStocksGrowthInput.value = annualStocksGrowthRate;
            annualCashMutualFundsGrowthInput.value = annualCashMutualFundsGrowthRate;
        }

        /**
         * Projects the portfolio values based on current asset values and annual growth rates.
         */
        function projectPortfolioValues() {
            const cryptoRate = 1 + (annualCryptoGrowthRate / 100);
            const stocksRate = 1 + (annualStocksGrowthRate / 100);
            const cashMutualFundsRate = 1 + (annualCashMutualFundsGrowthRate / 100);

            const projectedCrypto1Year = currentCryptoValue * cryptoRate;
            const projectedStocks1Year = currentStocksValue * stocksRate;
            const projectedCashMutualFunds1Year = currentCashMutualFundsValue * cashMutualFundsRate;

            const projectedCrypto3Years = currentCryptoValue * Math.pow(cryptoRate, 3);
            const projectedStocks3Years = currentStocksValue * Math.pow(stocksRate, 3);
            const projectedCashMutualFunds3Years = currentCashMutualFundsValue * Math.pow(cashMutualFundsRate, 3);

            const projectedCrypto5Years = currentCryptoValue * Math.pow(cryptoRate, 5);
            const projectedStocks5Years = currentStocksValue * Math.pow(stocksRate, 5);
            const projectedCashMutualFunds5Years = currentCashMutualFundsValue * Math.pow(cashMutualFundsRate, 5);

            const totalProjected1Year = projectedCrypto1Year + projectedStocks1Year + projectedCashMutualFunds1Year + currentCashCushion;
            const totalProjected3Years = projectedCrypto3Years + projectedStocks3Years + projectedCashMutualFunds3Years + currentCashCushion;
            const totalProjected5Years = projectedCrypto5Years + projectedStocks5Years + projectedCashMutualFunds5Years + currentCashCushion;

            projected1YearSpan.textContent = `$${totalProjected1Year.toFixed(2)}`;
            projected3YearsSpan.textContent = `$${totalProjected3Years.toFixed(2)}`;
            projected5YearsSpan.textContent = `$${totalProjected5Years.toFixed(2)}`;
        }

        /**
         * Updates the current cash cushion amount in Firestore.
         */
        async function updateCashCushion() {
            // Log state before operation
            console.log("--- Attempting to update cash cushion ---");
            console.log("db:", db);
            console.log("appId:", appId);
            console.log("userId:", userId);
            console.log("currentDataType:", currentDataType);

            if (!userId || !db) {
                showStatusMessage(cashCushionStatus, 'App not ready. Please log in and wait.', false);
                return;
            }
            clearInputError(currentCashCushionInput, cashCushionError);
            const amount = parseFloat(currentCashCushionInput.value);
            if (isNaN(amount) || amount < 0) {
                showInputError(currentCashCushionInput, cashCushionError, "Please enter a valid positive number.");
                return;
            }
            showButtonLoading(updateCashCushionBtn);
            try {
                const cashCushionDocRef = doc(db, `artifacts/${appId}/users/${userId}/${currentDataType}/data/cashCushion`, 'current');
                await setDoc(cashCushionDocRef, { amount: amount }, { merge: true });
                currentCashCushionInput.value = '';
                showStatusMessage(cashCushionStatus, 'Updated!');
            } catch (error) {
                console.error("Error updating cash cushion:", error.message || error);
                showStatusMessage(cashCushionStatus, 'Update failed!', false);
            } finally {
                hideButtonLoading(updateCashCushionBtn);
            }
        }

        /**
         * Updates the displayed cash cushion progress.
         */
        function updateCashCushionDisplay() {
            displaySavedCashCushionSpan.textContent = `$${currentCashCushion.toFixed(2)}`;
            const remaining = Math.max(0, CASH_CUSHION_TARGET - currentCashCushion);
            displayRemainingCashCushionSpan.textContent = `$${remaining.toFixed(2)}`;

            const progressPercentage = (currentCashCushion / CASH_CUSHION_TARGET) * 100;
            cashCushionProgressBar.style.width = `${Math.min(100, progressPercentage).toFixed(2)}%`;
            cashCushionProgressText.textContent = `${Math.min(100, progressPercentage).toFixed(0)}% of target achieved.`;
        }

        // Event Listeners for Authentication
        signUpBtn.addEventListener('click', handleSignUp);
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);

        // Event Listeners for Main App Functionality
        saveIncomeBtn.addEventListener('click', saveBiWeeklyIncome);
        addExpenseBtn.addEventListener('click', addExpense);
        addRandomExpenseBtn.addEventListener('click', addRandomExpense);
        saveAllocationBtn.addEventListener('click', savePortfolioAllocation);
        saveAssetValuesBtn.addEventListener('click', saveAssetValues);
        saveGrowthRatesBtn.addEventListener('click', saveGrowthRates);
        updateCashCushionBtn.addEventListener('click', updateCashCushion);

        // Event delegation for dynamically added expense buttons
        expensesList.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-expense-btn')) {
                const expenseId = event.target.dataset.id;
                removeExpense(expenseId);
            } else if (event.target.classList.contains('rename-expense-btn')) {
                const expenseId = event.target.dataset.id;
                const expenseItem = event.target.closest('.flex');
                const currentName = expenseItem.querySelector('span').textContent.split(':')[0].trim();
                showRenameModal(expenseId, currentName);
            }
        });

        // Data Type Radio Button Change Listener
        dataTypeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                currentDataType = event.target.value;
                console.log(`Switched to ${currentDataType} data.`);
                loadAllData();
            });
        });

        // Modal close buttons
        closeRenameModalBtn.addEventListener('click', hideRenameModal);
        confirmRenameBtn.addEventListener('click', handleRenameConfirm);

        cancelConfirmBtn.addEventListener('click', hideConfirmationModal);
        confirmActionBtn.addEventListener('click', () => {
            if (confirmationCallback) {
                confirmationCallback();
            }
        });

        // Initialize Firebase on window load
        window.onload = initializeFirebase;
    </script>
</body>
</html>
